# Google Play Payments Flow

Your Google Play payments setup works as a two-part lifecycle: at purchase time, the app sends the Play `purchaseToken` + `subscriptionId` (from your subscription product in Play Console) to the Supabase Edge Function `play-verify-purchase` (what you called `verify-play-purchase`), which uses the Google Android Publisher API via a service account (`GOOGLE_SERVICE_ACCOUNT_JSON`) to verify that the subscription is active, paid, acknowledged, and unexpired; if valid, it marks the user `is_pro=true` in Supabase auth metadata and stores a token-to-user mapping in `play_subscription_user`. Then for ongoing state changes, Google Play sends RTDN events through Pub/Sub (topic publisher IAM for `google-play-developer-notifications@system.gserviceaccount.com`) to your `play-rtdn` push endpoint, secured with `RTDN_SHARED_SECRET` in Supabase secrets, and `play-rtdn` decodes the notification and uses that stored mapping to revoke Pro on cancel/revoke/expire/voided events, so initial entitlement comes from API verification and long-term correctness comes from RTDN-driven updates.
